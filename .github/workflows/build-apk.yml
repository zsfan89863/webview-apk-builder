name: Build WebView APK

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'ç½‘ç«™URL'
        required: true
        type: string
      app_name:
        description: 'åº”ç”¨åç§°'
        required: true
        type: string
      package_name:
        description: 'åŒ…å'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        run: |
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O android-tools.zip
          mkdir -p $HOME/android-sdk/cmdline-tools
          unzip -q android-tools.zip -d $HOME/android-sdk/cmdline-tools
          mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
          
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
      
      - name: Create Keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=APK Builder, OU=Dev, O=Builder, L=City, S=State, C=US"
      
      - name: Create Android Project
        run: |
          echo "ğŸš€ åˆ›å»º Android é¡¹ç›®..."
          
          PACKAGE_PATH=$(echo "${{ inputs.package_name }}" | tr '.' '/')
          
          mkdir -p app/src/main/java/$PACKAGE_PATH
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          
          # åˆ›å»º MainActivityï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
          cat > app/src/main/java/$PACKAGE_PATH/MainActivity.java << 'JAVAEOF'
          package ${{ inputs.package_name }};
          
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import android.webkit.WebSettings;
          import android.webkit.WebChromeClient;
          import android.view.KeyEvent;
          import android.view.View;
          import android.widget.ProgressBar;
          import android.widget.TextView;
          import android.graphics.Bitmap;
          import android.net.http.SslError;
          import android.webkit.SslErrorHandler;
          
          public class MainActivity extends Activity {
              private WebView webView;
              private ProgressBar progressBar;
              private TextView loadingText;
              private View splashScreen;
              
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  
                  webView = findViewById(R.id.webview);
                  progressBar = findViewById(R.id.progress_bar);
                  loadingText = findViewById(R.id.loading_text);
                  splashScreen = findViewById(R.id.splash_screen);
                  
                  setupWebView();
                  webView.loadUrl("${{ inputs.website_url }}");
              }
              
              private void setupWebView() {
                  WebSettings settings = webView.getSettings();
                  settings.setJavaScriptEnabled(true);
                  settings.setDomStorageEnabled(true);
                  settings.setDatabaseEnabled(true);
                  settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);
                  settings.setCacheMode(WebSettings.LOAD_DEFAULT);
                  settings.setLoadWithOverviewMode(true);
                  settings.setUseWideViewPort(true);
                  settings.setSupportZoom(true);
                  settings.setBuiltInZoomControls(true);
                  settings.setDisplayZoomControls(false);
                  settings.setAllowFileAccess(true);
                  settings.setMediaPlaybackRequiresUserGesture(false);
                  
                  webView.setWebViewClient(new WebViewClient() {
                      @Override
                      public void onPageStarted(WebView view, String url, Bitmap favicon) {
                          super.onPageStarted(view, url, favicon);
                          progressBar.setVisibility(View.VISIBLE);
                          loadingText.setVisibility(View.VISIBLE);
                      }
                      
                      @Override
                      public void onPageFinished(WebView view, String url) {
                          super.onPageFinished(view, url);
                          progressBar.setVisibility(View.GONE);
                          loadingText.setVisibility(View.GONE);
                          
                          if (splashScreen.getVisibility() == View.VISIBLE) {
                              splashScreen.postDelayed(new Runnable() {
                                  @Override
                                  public void run() {
                                      splashScreen.setVisibility(View.GONE);
                                  }
                              }, 300);
                          }
                      }
                      
                      @Override
                      public void onReceivedSslError(WebView view, SslErrorHandler handler, SslError error) {
                          handler.proceed();
                      }
                  });
                  
                  webView.setWebChromeClient(new WebChromeClient() {
                      @Override
                      public void onProgressChanged(WebView view, int newProgress) {
                          super.onProgressChanged(view, newProgress);
                          progressBar.setProgress(newProgress);
                          loadingText.setText("åŠ è½½ä¸­ " + newProgress + "%");
                          
                          if (newProgress == 100) {
                              progressBar.postDelayed(new Runnable() {
                                  @Override
                                  public void run() {
                                      progressBar.setVisibility(View.GONE);
                                      loadingText.setVisibility(View.GONE);
                                  }
                              }, 200);
                          }
                      }
                      
                      @Override
                      public void onReceivedTitle(WebView view, String title) {
                          super.onReceivedTitle(view, title);
                      }
                  });
              }
              
              @Override
              public boolean onKeyDown(int keyCode, KeyEvent event) {
                  if (keyCode == KeyEvent.KEYCODE_BACK && webView.canGoBack()) {
                      webView.goBack();
                      return true;
                  }
                  return super.onKeyDown(keyCode, event);
              }
          }
          JAVAEOF
          
          # åˆ›å»ºå¸ƒå±€æ–‡ä»¶
          cat > app/src/main/res/layout/activity_main.xml << 'LAYOUTEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent">
              
              <!-- WebView -->
              <WebView
                  android:id="@+id/webview"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent" />
              
              <!-- è¿›åº¦æ¡å®¹å™¨ -->
              <LinearLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:orientation="vertical"
                  android:layout_alignParentTop="true"
                  android:background="#FFFFFF"
                  android:elevation="4dp">
                  
                  <!-- è¿›åº¦æ¡ -->
                  <ProgressBar
                      android:id="@+id/progress_bar"
                      style="?android:attr/progressBarStyleHorizontal"
                      android:layout_width="match_parent"
                      android:layout_height="3dp"
                      android:progressTint="#000000"
                      android:progressBackgroundTint="#E0E0E0"
                      android:visibility="gone"
                      android:max="100" />
                  
                  <!-- åŠ è½½æ–‡å­— -->
                  <TextView
                      android:id="@+id/loading_text"
                      android:layout_width="match_parent"
                      android:layout_height="wrap_content"
                      android:text="åŠ è½½ä¸­ 0%"
                      android:textSize="12sp"
                      android:textColor="#666666"
                      android:gravity="center"
                      android:padding="4dp"
                      android:visibility="gone" />
              </LinearLayout>
              
              <!-- å¯åŠ¨é—ªå± -->
              <FrameLayout
                  android:id="@+id/splash_screen"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent"
                  android:background="#FFFFFF"
                  android:clickable="true">
                  
                  <LinearLayout
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:layout_gravity="center"
                      android:orientation="vertical"
                      android:gravity="center">
                      
                      <ImageView
                          android:layout_width="80dp"
                          android:layout_height="80dp"
                          android:src="@mipmap/ic_launcher"
                          android:layout_marginBottom="16dp" />
                      
                      <TextView
                          android:layout_width="wrap_content"
                          android:layout_height="wrap_content"
                          android:text="${{ inputs.app_name }}"
                          android:textSize="24sp"
                          android:textColor="#000000"
                          android:textStyle="bold" />
                      
                      <ProgressBar
                          android:layout_width="32dp"
                          android:layout_height="32dp"
                          android:layout_marginTop="24dp"
                          android:indeterminateTint="#000000" />
                      
                      <TextView
                          android:layout_width="wrap_content"
                          android:layout_height="wrap_content"
                          android:text="æ­£åœ¨åŠ è½½..."
                          android:textSize="14sp"
                          android:textColor="#666666"
                          android:layout_marginTop="12dp" />
                  </LinearLayout>
              </FrameLayout>
          </RelativeLayout>
          LAYOUTEOF
          
          # åˆ›å»ºå›¾æ ‡
          for size in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
            convert -size 192x192 xc:#4CAF50 app/src/main/res/mipmap-$size/ic_launcher.png 2>/dev/null || echo "Skip icon"
          done
          
          # åˆ›å»º strings.xml
          cat > app/src/main/res/values/strings.xml << 'XMLEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${{ inputs.app_name }}</string>
          </resources>
          XMLEOF
          
          # åˆ›å»º colors.xml
          cat > app/src/main/res/values/colors.xml << 'COLORSEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="colorPrimary">#000000</color>
              <color name="colorPrimaryDark">#000000</color>
              <color name="colorAccent">#000000</color>
          </resources>
          COLORSEOF
          
          # åˆ›å»º AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'MANIFESTEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="${{ inputs.package_name }}">
              
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
              
              <application
                  android:label="@string/app_name"
                  android:icon="@mipmap/ic_launcher"
                  android:usesCleartextTraffic="true"
                  android:hardwareAccelerated="true"
                  android:theme="@android:style/Theme.NoTitleBar.Fullscreen">
                  <activity 
                      android:name=".MainActivity"
                      android:exported="true"
                      android:configChanges="orientation|screenSize|keyboardHidden"
                      android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          MANIFESTEOF
          
          # åˆ›å»º app/build.gradle
          cat > app/build.gradle << 'GRADLEEOF'
          plugins {
              id 'com.android.application'
          }
          
          android {
              namespace '${{ inputs.package_name }}'
              compileSdk 34
              
              defaultConfig {
                  applicationId "${{ inputs.package_name }}"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              
              signingConfigs {
                  release {
                      storeFile file('../release.keystore')
                      storePassword 'android'
                      keyAlias 'release'
                      keyPassword 'android'
                  }
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          GRADLEEOF
          
          # åˆ›å»ºæ ¹ build.gradle
          cat > build.gradle << 'ROOTGRADLEEOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          ROOTGRADLEEOF
          
          cat > settings.gradle << 'SETTINGSEOF'
          rootProject.name = "WebViewAPK"
          include ':app'
          SETTINGSEOF
          
          cat > gradle.properties << 'PROPSEOF'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          PROPSEOF
          
          echo "sdk.dir=$HOME/android-sdk" > local.properties
      
      - name: Create Gradle Wrapper
        run: |
          gradle wrapper --gradle-version 8.2
          chmod +x ./gradlew
      
      - name: Build Signed APK
        run: |
          echo "ğŸ”¨ æ„å»ºå·²ç­¾åçš„ APK..."
          ./gradlew assembleRelease --stacktrace
          ls -lh app/build/outputs/apk/release/
      
      - name: Rename APK
        run: |
          cd app/build/outputs/apk/release
          mv app-release.apk "${{ inputs.app_name }}.apk"
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}
          path: app/build/outputs/apk/release/${{ inputs.app_name }}.apk
          retention-days: 7
      
      - name: Build Summary
        run: |
          echo "âœ… æ„å»ºå®Œæˆï¼"
          echo "åº”ç”¨åç§°: ${{ inputs.app_name }}"
          echo "åŒ…å: ${{ inputs.package_name }}"
          echo "ç½‘ç«™: ${{ inputs.website_url }}"
