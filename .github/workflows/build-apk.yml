name: Build WebView APK

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'ç½‘ç«™URL'
        required: true
        type: string
      app_name:
        description: 'åº”ç”¨åç§°'
        required: true
        type: string
      package_name:
        description: 'åŒ…å'
        required: true
        type: string
      icon_url:
        description: 'å›¾æ ‡URL'
        required: false
        type: string
      version_name:
        description: 'ç‰ˆæœ¬åç§°'
        required: false
        type: string
        default: '1.0.0'
      version_code:
        description: 'ç‰ˆæœ¬å·'
        required: false
        type: string
        default: '1'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        run: |
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O android-tools.zip
          mkdir -p $HOME/android-sdk/cmdline-tools
          unzip -q android-tools.zip -d $HOME/android-sdk/cmdline-tools
          mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
          sudo apt-get update
          sudo apt-get install -y imagemagick
      
      - name: Create Keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Builder, OU=Dev, O=APK, L=City, S=State, C=US"
      
      - name: Process Icon
        run: |
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          
          if [ -n "${{ inputs.icon_url }}" ]; then
            echo "ğŸ¨ ä¸‹è½½è‡ªå®šä¹‰å›¾æ ‡"
            wget -q "${{ inputs.icon_url }}" -O original_icon.png || {
              echo "âš ï¸ å›¾æ ‡ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡"
              convert -size 192x192 xc:#4CAF50 -fill white -gravity center -pointsize 120 -annotate +0+0 "A" original_icon.png
            }
            
            convert original_icon.png -resize 48x48 app/src/main/res/mipmap-mdpi/ic_launcher.png
            convert original_icon.png -resize 72x72 app/src/main/res/mipmap-hdpi/ic_launcher.png
            convert original_icon.png -resize 96x96 app/src/main/res/mipmap-xhdpi/ic_launcher.png
            convert original_icon.png -resize 144x144 app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            convert original_icon.png -resize 192x192 app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          else
            echo "ğŸ“¦ ä½¿ç”¨é»˜è®¤å›¾æ ‡"
            convert -size 192x192 xc:#4CAF50 -fill white -gravity center -pointsize 120 -annotate +0+0 "A" temp_icon.png
            
            convert temp_icon.png -resize 48x48 app/src/main/res/mipmap-mdpi/ic_launcher.png
            convert temp_icon.png -resize 72x72 app/src/main/res/mipmap-hdpi/ic_launcher.png
            convert temp_icon.png -resize 96x96 app/src/main/res/mipmap-xhdpi/ic_launcher.png
            convert temp_icon.png -resize 144x144 app/src/main/res/mipmap-xxhdpi/ic_launcher.png
            convert temp_icon.png -resize 192x192 app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          fi
      
      - name: Create Android Project
        run: |
          echo "ğŸš€ åˆ›å»ºé¡¹ç›®..."
          
          PACKAGE_PATH=$(echo "${{ inputs.package_name }}" | tr '.' '/')
          
          mkdir -p app/src/main/java/$PACKAGE_PATH
          mkdir -p app/src/main/res/values
          
          # MainActivity - çº¯ Android API ç‰ˆæœ¬
          cat > app/src/main/java/$PACKAGE_PATH/MainActivity.java << 'EOF'
          package ${{ inputs.package_name }};
          
          import android.app.Activity;
          import android.app.DownloadManager;
          import android.content.Context;
          import android.net.Uri;
          import android.os.Bundle;
          import android.os.Environment;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import android.webkit.WebSettings;
          import android.webkit.WebChromeClient;
          import android.webkit.DownloadListener;
          import android.webkit.CookieManager;
          import android.view.KeyEvent;
          import android.view.Window;
          import android.view.WindowManager;
          import android.view.View;
          import android.view.ViewGroup;
          import android.widget.ProgressBar;
          import android.widget.RelativeLayout;
          import android.widget.FrameLayout;
          import android.widget.Toast;
          import android.graphics.Bitmap;
          import android.graphics.Color;
          import android.os.Build;
          
          public class MainActivity extends Activity {
              private WebView webView;
              private ProgressBar progressBar;
              private FrameLayout refreshLayout;
              private View pullToRefreshView;
              private float startY;
              private boolean isPulling = false;
              
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  
                  setupFullscreen();
                  
                  // å¯ç”¨ Cookie æŒä¹…åŒ–
                  CookieManager cookieManager = CookieManager.getInstance();
                  cookieManager.setAcceptCookie(true);
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                      cookieManager.setAcceptThirdPartyCookies(null, true);
                  }
                  
                  // åˆ›å»ºæ ¹å¸ƒå±€
                  RelativeLayout rootLayout = new RelativeLayout(this);
                  
                  // WebView
                  webView = new WebView(this);
                  RelativeLayout.LayoutParams webParams = new RelativeLayout.LayoutParams(
                      RelativeLayout.LayoutParams.MATCH_PARENT,
                      RelativeLayout.LayoutParams.MATCH_PARENT
                  );
                  rootLayout.addView(webView, webParams);
                  
                  // è¿›åº¦æ¡
                  progressBar = new ProgressBar(this, null, android.R.attr.progressBarStyleHorizontal);
                  RelativeLayout.LayoutParams progressParams = new RelativeLayout.LayoutParams(
                      RelativeLayout.LayoutParams.MATCH_PARENT, 8
                  );
                  progressParams.addRule(RelativeLayout.ALIGN_PARENT_TOP);
                  progressBar.setMax(100);
                  rootLayout.addView(progressBar, progressParams);
                  
                  setContentView(rootLayout);
                  
                  setupWebView();
                  setupDownload();
                  setupPullToRefresh();
                  
                  webView.loadUrl("${{ inputs.website_url }}");
              }
              
              private void setupFullscreen() {
                  requestWindowFeature(Window.FEATURE_NO_TITLE);
                  getWindow().setFlags(
                      WindowManager.LayoutParams.FLAG_FULLSCREEN,
                      WindowManager.LayoutParams.FLAG_FULLSCREEN
                  );
                  
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
                      getWindow().getDecorView().setSystemUiVisibility(
                          View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                          | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                          | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                          | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                          | View.SYSTEM_UI_FLAG_FULLSCREEN
                          | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                      );
                  }
                  
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                      Window window = getWindow();
                      window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
                      window.setStatusBarColor(Color.BLACK);
                      window.setNavigationBarColor(Color.BLACK);
                  }
              }
              
              private void setupWebView() {
                  WebSettings settings = webView.getSettings();
                  settings.setJavaScriptEnabled(true);
                  settings.setDomStorageEnabled(true);
                  settings.setDatabaseEnabled(true);
                  settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);
                  settings.setCacheMode(WebSettings.LOAD_DEFAULT);
                  settings.setLoadWithOverviewMode(true);
                  settings.setUseWideViewPort(true);
                  settings.setSupportZoom(true);
                  settings.setBuiltInZoomControls(true);
                  settings.setDisplayZoomControls(false);
                  settings.setAllowFileAccess(true);
                  settings.setMediaPlaybackRequiresUserGesture(false);
                  settings.setAppCacheEnabled(true);
                  settings.setAppCachePath(getCacheDir().getAbsolutePath());
                  
                  webView.setWebViewClient(new WebViewClient() {
                      @Override
                      public void onPageStarted(WebView view, String url, Bitmap favicon) {
                          super.onPageStarted(view, url, favicon);
                          progressBar.setVisibility(View.VISIBLE);
                      }
                      
                      @Override
                      public void onPageFinished(WebView view, String url) {
                          super.onPageFinished(view, url);
                          progressBar.setVisibility(View.GONE);
                          
                          // è¯»å– theme-color
                          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                              view.evaluateJavascript(
                                  "(function() { var meta = document.querySelector('meta[name=\"theme-color\"]'); return meta ? meta.content : null; })();",
                                  value -> {
                                      if (value != null && !value.equals("null") && !value.equals("\"null\"")) {
                                          try {
                                              String color = value.replace("\"", "");
                                              int colorInt = Color.parseColor(color);
                                              getWindow().setStatusBarColor(colorInt);
                                              getWindow().setNavigationBarColor(colorInt);
                                              
                                              if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                                                  if (isColorDark(colorInt)) {
                                                      getWindow().getDecorView().setSystemUiVisibility(
                                                          View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                                                          | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                                                          | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                                                          | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                                                          | View.SYSTEM_UI_FLAG_FULLSCREEN
                                                          | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                                                      );
                                                  } else {
                                                      getWindow().getDecorView().setSystemUiVisibility(
                                                          View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                                                          | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                                                          | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                                                          | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                                                          | View.SYSTEM_UI_FLAG_FULLSCREEN
                                                          | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                                                          | View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR
                                                      );
                                                  }
                                              }
                                          } catch (Exception e) {
                                              e.printStackTrace();
                                          }
                                      }
                                  }
                              );
                          }
                      }
                  });
                  
                  webView.setWebChromeClient(new WebChromeClient() {
                      @Override
                      public void onProgressChanged(WebView view, int newProgress) {
                          super.onProgressChanged(view, newProgress);
                          progressBar.setProgress(newProgress);
                          if (newProgress == 100) {
                              progressBar.postDelayed(() -> {
                                  progressBar.setVisibility(View.GONE);
                              }, 300);
                          }
                      }
                  });
              }
              
              private void setupPullToRefresh() {
                  webView.setOnTouchListener((v, event) -> {
                      switch (event.getAction()) {
                          case android.view.MotionEvent.ACTION_DOWN:
                              startY = event.getY();
                              break;
                          case android.view.MotionEvent.ACTION_MOVE:
                              if (webView.getScrollY() == 0) {
                                  float currentY = event.getY();
                                  float diff = currentY - startY;
                                  if (diff > 100 && !isPulling) {
                                      isPulling = true;
                                      webView.reload();
                                      Toast.makeText(MainActivity.this, "åˆ·æ–°ä¸­...", Toast.LENGTH_SHORT).show();
                                  }
                              }
                              break;
                          case android.view.MotionEvent.ACTION_UP:
                              isPulling = false;
                              break;
                      }
                      return false;
                  });
              }
              
              private void setupDownload() {
                  webView.setDownloadListener(new DownloadListener() {
                      @Override
                      public void onDownloadStart(String url, String userAgent, String contentDisposition, 
                                                   String mimeType, long contentLength) {
                          try {
                              DownloadManager.Request request = new DownloadManager.Request(Uri.parse(url));
                              request.setMimeType(mimeType);
                              
                              String filename = contentDisposition;
                              if (filename == null || filename.isEmpty()) {
                                  filename = url.substring(url.lastIndexOf("/") + 1);
                              }
                              
                              request.setTitle(filename);
                              request.setDescription("æ­£åœ¨ä¸‹è½½æ–‡ä»¶...");
                              request.allowScanningByMediaScanner();
                              request.setNotificationVisibility(
                                  DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED
                              );
                              request.setDestinationInExternalPublicDir(
                                  Environment.DIRECTORY_DOWNLOADS, filename
                              );
                              
                              DownloadManager dm = (DownloadManager) getSystemService(Context.DOWNLOAD_SERVICE);
                              if (dm != null) {
                                  dm.enqueue(request);
                                  Toast.makeText(MainActivity.this, "å¼€å§‹ä¸‹è½½ï¼š" + filename, Toast.LENGTH_SHORT).show();
                              }
                          } catch (Exception e) {
                              Toast.makeText(MainActivity.this, "ä¸‹è½½å¤±è´¥", Toast.LENGTH_SHORT).show();
                          }
                      }
                  });
              }
              
              private boolean isColorDark(int color) {
                  double darkness = 1 - (0.299 * Color.red(color) + 0.587 * Color.green(color) + 0.114 * Color.blue(color)) / 255;
                  return darkness >= 0.5;
              }
              
              @Override
              public boolean onKeyDown(int keyCode, KeyEvent event) {
                  if (keyCode == KeyEvent.KEYCODE_BACK && webView.canGoBack()) {
                      webView.goBack();
                      return true;
                  }
                  return super.onKeyDown(keyCode, event);
              }
              
              @Override
              protected void onPause() {
                  super.onPause();
                  webView.onPause();
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                      CookieManager.getInstance().flush();
                  }
              }
              
              @Override
              protected void onResume() {
                  super.onResume();
                  webView.onResume();
              }
          }
          EOF
          
          # strings.xml
          cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${{ inputs.app_name }}</string>
          </resources>
          EOF
          
          # AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="${{ inputs.package_name }}"
              android:versionCode="${{ inputs.version_code }}"
              android:versionName="${{ inputs.version_name }}">
              
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
                               android:maxSdkVersion="28" />
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" 
                               android:maxSdkVersion="32" />
              
              <application
                  android:label="@string/app_name"
                  android:icon="@mipmap/ic_launcher"
                  android:usesCleartextTraffic="true"
                  android:hardwareAccelerated="true"
                  android:requestLegacyExternalStorage="true"
                  android:theme="@android:style/Theme.NoTitleBar.Fullscreen">
                  <activity 
                      android:name=".MainActivity"
                      android:exported="true"
                      android:configChanges="orientation|screenSize|keyboardHidden">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # app/build.gradle - ä¸ä½¿ç”¨ AndroidX
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }
          
          android {
              namespace '${{ inputs.package_name }}'
              compileSdk 34
              
              defaultConfig {
                  applicationId "${{ inputs.package_name }}"
                  minSdk 21
                  targetSdk 34
                  versionCode ${{ inputs.version_code }}
                  versionName "${{ inputs.version_name }}"
              }
              
              signingConfigs {
                  release {
                      storeFile file('../release.keystore')
                      storePassword 'android'
                      keyAlias 'release'
                      keyPassword 'android'
                  }
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled false
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          EOF
          
          cat > build.gradle << 'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF
          
          cat > settings.gradle << 'EOF'
          rootProject.name = "WebViewAPK"
          include ':app'
          EOF
          
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          EOF
          
          echo "sdk.dir=$HOME/android-sdk" > local.properties
      
      - name: Create Gradle Wrapper
        run: |
          gradle wrapper --gradle-version 8.2
          chmod +x ./gradlew
      
      - name: Build APK
        run: |
          echo "ğŸ”¨ æ„å»º APK..."
          ./gradlew assembleRelease --stacktrace
      
      - name: Rename APK
        run: |
          cd app/build/outputs/apk/release
          mv app-release.apk "${{ inputs.app_name }}-v${{ inputs.version_name }}.apk"
          ls -lh
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-v${{ inputs.version_name }}
          path: app/build/outputs/apk/release/${{ inputs.app_name }}-v${{ inputs.version_name }}.apk
          retention-days: 7
      
      - name: Build Summary
        run: |
          echo "âœ… æ„å»ºå®Œæˆï¼"
          echo "åŠŸèƒ½: ä¸‹æ‹‰åˆ·æ–° + æ–‡ä»¶ä¸‹è½½ + å…¨å±æ¨¡å¼ + CookieæŒä¹…åŒ– + çŠ¶æ€æ è‡ªé€‚åº”"
